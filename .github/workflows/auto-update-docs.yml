name: Auto-Update Documentation

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running documentation check'
        required: false
        default: 'Manual documentation audit'

  # Optional: Trigger on PR merge (but not for docs PRs)
  pull_request:
    types: [closed]
    branches:
      - main
      - master

permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: read

jobs:
  update-docs:
    # Only run if manually triggered OR if PR was merged AND not a docs PR
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       !startsWith(github.head_ref, 'docs/') &&
       !contains(github.event.pull_request.title, 'docs:'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better git context
          ref: ${{ github.event.pull_request.base.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine trigger context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "trigger=manual" >> $GITHUB_OUTPUT
            echo "reason=${{ github.event.inputs.reason }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ github.event.inputs.reason }}"
          else
            echo "trigger=pr_merge" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "PR merge trigger: PR #${{ github.event.pull_request.number }}"
          fi

      - name: Generate documentation update branch name
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          if [ "${{ steps.context.outputs.trigger }}" = "manual" ]; then
            BRANCH="docs/auto-audit-${TIMESTAMP}"
          else
            BRANCH="docs/auto-update-pr-${{ steps.context.outputs.pr_number }}-${TIMESTAMP}"
          fi
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          echo "Generated branch name: $BRANCH"

      - name: Run Claude Code to audit and update documentation
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          claude_args: "--allowedTools 'Edit,Read,Glob,Grep,Bash(git:*),Bash(gh:*)'"
          prompt: |
            # Comprehensive Documentation Audit

            **Trigger:** ${{ steps.context.outputs.trigger == 'manual' && steps.context.outputs.reason || format('PR #{0}: {1}', steps.context.outputs.pr_number, steps.context.outputs.pr_title) }}

            Your task is to perform a comprehensive audit of ALL documentation in this repository to identify and fix any issues.

            ## CRITICAL REQUIREMENTS

            **VERY IMPORTANT - READ THIS CAREFULLY:**

            1. **CHECK EVERYTHING** - Do not limit yourself to recently changed files. Audit ALL documentation across the entire repository.

            2. **ONLY UPDATE IF ISSUES FOUND** - You should ONLY make changes if you find actual problems:
               - ‚ùå **Incomplete documentation** - Missing JSDoc, missing parameters, missing return types
               - ‚ùå **Inconsistent documentation** - JSDoc doesn't match function signature or behavior
               - ‚ùå **Discrepancies** - Documentation contradicts the actual code
               - ‚ùå **Outdated information** - Documentation references old patterns, deprecated APIs, or removed features
               - ‚ùå **Incorrect information** - Documentation describes behavior that doesn't exist

            3. **DO NOT UPDATE IF NO ISSUES** - If documentation is complete, accurate, and up-to-date, DO NOT make any changes. Simply finish the workflow and report that no updates were needed.

            4. **DOCUMENTATION ONLY** - NEVER modify code implementation, logic, variable names, imports, or add features.

            ## Step 1: Comprehensive Documentation Discovery

            Find ALL documentation in the repository:

            1. **JSDoc Comments** - All TypeScript/JavaScript files with functions, classes, types:
               ```bash
               # Find all source files
               find src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) | head -100
               ```

            2. **Markdown Documentation**:
               - Root level: `README.md`, `CLAUDE.md`
               - Handbook: `handbook/*.md`
               - Module docs: `src/modules/*/DOCS.md`, `src/modules/*/README.md`
               - Feature docs: Any `README.md` or `DOCS.md` in `src/` subdirectories
               - Workflow docs: `.github/workflows/README.md`

            3. **Configuration Documentation**:
               - `package.json` - Check if scripts have descriptions
               - Any config files with comments

            ## Step 2: Audit Each Documentation Type

            For EACH piece of documentation found, check:

            ### JSDoc Audit Checklist:
            - [ ] Does every exported function have a JSDoc comment?
            - [ ] Does the description accurately describe what the function does?
            - [ ] Are all @param tags present with correct names and types?
            - [ ] Is @returns documented with correct type?
            - [ ] Do the documented parameters match the actual function signature?
            - [ ] Are examples still valid for current implementation?
            - [ ] Are any deprecated patterns mentioned that should be updated?

            ### Markdown Documentation Audit Checklist:
            - [ ] Do usage examples reference functions/APIs that still exist?
            - [ ] Are code snippets syntactically correct and runnable?
            - [ ] Do file paths and imports match current structure?
            - [ ] Are feature lists accurate (no removed features listed)?
            - [ ] Are architecture diagrams/descriptions current?
            - [ ] Are setup instructions still valid?
            - [ ] Are command examples correct?

            ## Step 3: Decision Point - UPDATE OR SKIP

            After auditing, you must decide:

            ### IF YOU FOUND ISSUES:

            Create a detailed report of issues found, then proceed to Step 4 to fix them.

            Example issues report:
            ```
            ISSUES FOUND:

            1. src/modules/auth/hooks/useAuth.ts:15
               - Missing JSDoc for `login` function
               - Parameter `credentials` not documented

            2. src/shared/components/ui/Button.tsx:42
               - JSDoc says returns `void` but actually returns `Promise<void>`

            3. handbook/architecture.md:67
               - References old `src/core/` structure that was moved to `src/shared/`

            4. CLAUDE.md:120
               - Lists `npm run test:e2e` but this script doesn't exist in package.json
            ```

            ### IF NO ISSUES FOUND:

            **DO NOT CREATE A BRANCH OR PR**. Instead:

            1. Print a comprehensive report explaining why no updates are needed:
            ```
            DOCUMENTATION AUDIT COMPLETE - NO UPDATES NEEDED

            Audit Summary:
            - Checked X TypeScript/JavaScript files
            - Reviewed X JSDoc comments
            - Reviewed X markdown files
            - Total functions audited: X
            - Total markdown sections audited: X

            All documentation is:
            ‚úÖ Complete - All functions have JSDoc, all parameters documented
            ‚úÖ Accurate - Documentation matches actual code behavior
            ‚úÖ Consistent - No contradictions between docs and code
            ‚úÖ Up-to-date - No references to deprecated or removed features

            No pull request needed.
            ```

            2. **EXIT IMMEDIATELY** - Do not create a branch, do not commit, do not create a PR.

            ## Step 4: Fix Issues (ONLY IF ISSUES FOUND)

            If you found issues in Step 3:

            1. Create a new branch:
            ```bash
            git checkout -b ${{ steps.branch.outputs.name }}
            ```

            2. Fix each issue identified in your audit:
               - Update JSDoc comments to be complete and accurate
               - Fix markdown documentation to match current code
               - Correct any outdated references or examples
               - **DO NOT modify code - only documentation**

            3. Check what you changed:
            ```bash
            git status
            git diff
            ```

            4. Commit your changes:
            ```bash
            git add .
            git commit -m "docs: fix documentation issues found in audit

            Fixed issues:
            - [List each issue fixed with file:line reference]

            Audit trigger: ${{ steps.context.outputs.trigger == 'manual' && steps.context.outputs.reason || format('PR #{0}', steps.context.outputs.pr_number) }}

            ü§ñ Auto-generated by Claude Code"
            ```

            5. Push the branch:
            ```bash
            git push -u origin ${{ steps.branch.outputs.name }}
            ```

            ## Step 5: Create Pull Request (ONLY IF CHANGES MADE)

            **ONLY IF you created a branch and committed changes**:

            ```bash
            gh pr create \
              --title "docs: Fix documentation issues from automated audit" \
              --body "## Summary

            This PR fixes documentation issues identified during an automated comprehensive documentation audit.

            **Trigger:** ${{ steps.context.outputs.trigger == 'manual' && steps.context.outputs.reason || format('PR #{0}: {1}', steps.context.outputs.pr_number, steps.context.outputs.pr_title) }}

            ## Issues Found and Fixed

            [Provide detailed list of each issue fixed, with file paths and line numbers]

            Example:
            1. **src/modules/auth/hooks/useAuth.ts:15**
               - Issue: Missing JSDoc for \`login\` function
               - Fix: Added complete JSDoc with @param and @returns

            2. **handbook/architecture.md:67**
               - Issue: Referenced old \`src/core/\` structure
               - Fix: Updated to reference current \`src/shared/\` structure

            ## Audit Statistics

            - Files audited: X
            - JSDoc comments reviewed: X
            - Markdown files reviewed: X
            - Issues found: X
            - Issues fixed: X

            ## Review Checklist

            - [ ] All JSDoc comments are complete and accurate
            - [ ] All markdown documentation matches current code
            - [ ] No code implementation was modified
            - [ ] Only documentation was updated

            ---

            ü§ñ Auto-generated by Claude Code Documentation Audit" \
              --base main
            ```

            6. Verify PR creation:
            ```bash
            gh pr view
            ```

            ## Final Report

            At the end, provide a clear summary:

            - If issues found: "Created PR with X documentation fixes"
            - If no issues: "No documentation updates needed - all docs are current and accurate"

      - name: Add workflow summary
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## Documentation Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Trigger Information" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.context.outputs.trigger }}" = "manual" ]; then
            echo "- **Trigger:** Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
            echo "- **Reason:** ${{ steps.context.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Trigger:** PR Merge" >> $GITHUB_STEP_SUMMARY
            echo "- **PR:** [#${{ steps.context.outputs.pr_number }}](${{ github.event.pull_request.html_url }})" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Title:** ${{ steps.context.outputs.pr_title }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if documentation PR was created
          if gh pr list --head ${{ steps.branch.outputs.name }} --json number,title,url --jq '.[0]' > /tmp/doc_pr_info.json 2>/dev/null && [ -s /tmp/doc_pr_info.json ]; then
            DOC_PR_URL=$(cat /tmp/doc_pr_info.json | jq -r '.url')
            DOC_PR_NUMBER=$(cat /tmp/doc_pr_info.json | jq -r '.number')
            DOC_PR_TITLE=$(cat /tmp/doc_pr_info.json | jq -r '.title')
            echo "### ‚úÖ Documentation Issues Found - PR Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The audit found documentation issues that need to be fixed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Documentation PR:** [#${DOC_PR_NUMBER} - ${DOC_PR_TITLE}](${DOC_PR_URL})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the PR for details on what issues were found and fixed." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Documentation Audit Complete - No Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The comprehensive documentation audit found no issues." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All documentation is:" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Complete" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Accurate" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Consistent" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Up-to-date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No pull request was created because no updates were needed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the Claude Code step output above for the detailed audit report." >> $GITHUB_STEP_SUMMARY
          fi
