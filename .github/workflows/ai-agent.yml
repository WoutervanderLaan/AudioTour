name: AI Agent Task Runner

on:
  workflow_dispatch:
    inputs:
      trelloCardId:
        description: "Trello card ID to associate with the task"
        required: true
      title:
        description: "Short title for the task or PR"
        required: true
      description:
        description: "Detailed description of the task"
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  run-claude:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Show workflow inputs
        run: |
          echo "=== Workflow Inputs ==="
          echo "Trello Card ID: ${{ github.event.inputs.trelloCardId }}"
          echo "Title: ${{ github.event.inputs.title }}"
          echo "Description: ${{ github.event.inputs.description }}"
          echo "======================="

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for better git context
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Debug - Show git state before
        run: |
          echo "=== Git State Before ==="
          git branch -a
          git status
          echo "Current branch: $(git branch --show-current)"
          echo "======================="

      - name: Generate branch name
        id: branch
        run: |
          # Sanitize title for branch name (replace spaces/special chars with hyphens)
          SANITIZED_TITLE=$(echo "${{ github.event.inputs.title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | cut -c1-50)
          BRANCH="trello/${{ github.event.inputs.trelloCardId }}/${SANITIZED_TITLE}"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          echo "Generated branch name: $BRANCH"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          claude_args: "--allowedTools 'Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(bun:*),Bash(npm:*),Bash(npx:*),Bash(gh:*)'"
          prompt: |
            # Trello Task: ${{ github.event.inputs.title }}

            **Trello Card ID:** ${{ github.event.inputs.trelloCardId }}

            ## Task Description
            ${{ github.event.inputs.description }}

            ## Instructions

            **CRITICAL: You MUST complete ALL steps below to finish this task. Do not skip any steps.**

            ### Step 1: Create Branch
            Create a new branch named `${{ steps.branch.outputs.name }}` from the current main branch:
            ```bash
            git checkout -b ${{ steps.branch.outputs.name }}
            ```

            ### Step 2: Implement the Task
            Implement the task completely following the project guidelines in CLAUDE.md:
            - Use feature-based architecture under src/features/ for new features
            - Follow import rules (use @/* absolute imports)
            - Respect ESLint boundaries between app/features/shared/store
            - Use react-native-unistyles for styling (never inline styles)
            - Add JSDoc comments to all functions
            - Keep functions under 120 lines and files under 300 lines

            ### Step 3: Validate Your Changes
            Run the validation commands and fix any issues:
            ```bash
            npm run validate   # Must pass: lint, typecheck, format checks
            npm test          # Must pass: if tests exist
            ```
            If any validation fails, fix the issues before proceeding.

            ### Step 4: Commit Your Changes
            **REQUIRED:** You must commit all changes before pushing:
            ```bash
            git add .
            git commit -m "[Trello-${{ github.event.inputs.trelloCardId }}] ${{ github.event.inputs.title }}

            ${{ github.event.inputs.description }}

            ðŸ¤– Generated with Claude Code"
            ```

            ### Step 5: Push Your Branch
            **REQUIRED:** Push your branch to the remote repository:
            ```bash
            git push -u origin ${{ steps.branch.outputs.name }}
            ```
            Verify the push succeeded before continuing.

            ### Step 6: Create Pull Request
            **REQUIRED:** Create a PR using the gh CLI:
            ```bash
            gh pr create \
              --title "[Trello-${{ github.event.inputs.trelloCardId }}] ${{ github.event.inputs.title }}" \
              --body "## Summary
            [Summarize the changes made]

            ## Trello Card
            https://trello.com/c/${{ github.event.inputs.trelloCardId }}

            ## Test Plan
            - [ ] Validation passes (lint, typecheck, format)
            - [ ] Tests pass
            - [ ] Manual testing completed

            ## Notes
            [Any relevant notes or considerations]

            ðŸ¤– Generated with Claude Code" \
              --base main
            ```

            ### Final Verification
            After completing all steps:
            1. Verify the branch exists remotely: `git ls-remote --heads origin ${{ steps.branch.outputs.name }}`
            2. Verify the PR was created: `gh pr view`
            3. Report the PR URL to confirm success

            **IMPORTANT:**
            - Do NOT skip the commit step - changes must be committed
            - Do NOT skip the push step - the branch must be on the remote
            - Do NOT skip the PR creation step - this is the final deliverable
            - If any step fails, fix the issue before proceeding to the next step

      - name: Debug - Show git state after
        if: always()
        run: |
          echo "=== Git State After ==="
          git branch -a
          git status
          echo "Current branch: $(git branch --show-current)"
          echo "Recent commits:"
          git log --oneline -5
          echo "======================="

      - name: Debug - Check if branch exists remotely
        if: always()
        continue-on-error: true
        run: |
          echo "=== Checking Remote Branch ==="
          git fetch origin
          if git ls-remote --heads origin ${{ steps.branch.outputs.name }} | grep -q ${{ steps.branch.outputs.name }}; then
            echo "âœ… Branch '${{ steps.branch.outputs.name }}' exists on remote"
          else
            echo "âŒ Branch '${{ steps.branch.outputs.name }}' NOT found on remote"
          fi
          echo "======================="

      - name: Debug - Check for PR
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Checking for Pull Request ==="
          if gh pr list --head ${{ steps.branch.outputs.name }} --json number,title,url | grep -q "number"; then
            echo "âœ… Pull request found:"
            gh pr list --head ${{ steps.branch.outputs.name }} --json number,title,url
          else
            echo "âŒ No pull request found for branch '${{ steps.branch.outputs.name }}'"
          fi
          echo "======================="

      - name: Add workflow run summary
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## AI Agent Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Task Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trello Card:** [${{ github.event.inputs.trelloCardId }}](https://trello.com/c/${{ github.event.inputs.trelloCardId }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ github.event.inputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.branch.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Claude Step Status:** ${{ steps.claude.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if PR was created
          if gh pr list --head ${{ steps.branch.outputs.name }} --json number,title,url --jq '.[0]' > /tmp/pr_info.json 2>/dev/null && [ -s /tmp/pr_info.json ]; then
            PR_URL=$(cat /tmp/pr_info.json | jq -r '.url')
            PR_NUMBER=$(cat /tmp/pr_info.json | jq -r '.number')
            PR_TITLE=$(cat /tmp/pr_info.json | jq -r '.title')
            echo "### âœ… Pull Request Created" >> $GITHUB_STEP_SUMMARY
            echo "- **PR #${PR_NUMBER}:** [${PR_TITLE}](${PR_URL})" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ No Pull Request Found" >> $GITHUB_STEP_SUMMARY
            echo "The workflow completed but no PR was detected. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
